name: 🚀 LLMOps Watcher CI

on:
  push:
    branches: [ main ]

jobs:
  build-and-run:
    runs-on: windows-latest  # Use windows runner as you said

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 📂 Create folders with .gitkeep if missing (PowerShell)
        shell: pwsh
        run: |
          $dirs = @('testing_data', 'prompts', 'configs', 'logs', 'best_model', 'best_prompt')
          foreach ($d in $dirs) {
            if (-not (Test-Path $d)) {
              New-Item -ItemType Directory -Path $d | Out-Null
            }
            New-Item -ItemType File -Path "$d/.gitkeep" -Force | Out-Null
          }

      - name: 🧪 Debug - Check folders before mount (PowerShell)
        shell: pwsh
        run: |
          Write-Host "Checking folder contents:"
          $dirs = @('testing_data', 'prompts', 'configs', 'logs', 'best_model', 'best_prompt')
          foreach ($d in $dirs) {
            Write-Host "--- $d ---"
            Get-ChildItem $d | Format-Table
          }

      - name: 🐳 Docker version (PowerShell)
        shell: pwsh
        run: docker version

      - name: 🐳 Docker Compose version (PowerShell)
        shell: pwsh
        run: docker-compose version

      - name: ⚙️ Build and run with Docker Compose (PowerShell)
        shell: pwsh
        run: |
          docker-compose down --volumes --remove-orphans
          docker-compose up --build --abort-on-container-exit

      - name: 🐳 Debug logs if container failed (PowerShell)
        if: failure()
        shell: pwsh
        run: docker-compose logs
